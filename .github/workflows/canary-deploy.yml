name: Canary Deploy Gate

on:
  workflow_dispatch:
    inputs:
      rollout_mode:
        description: "Deployment mode"
        required: true
        type: choice
        options:
          - canary-only
          - full-rollout
      canary_worker_name:
        description: "Canary API worker name override"
        required: true
        type: string
        default: "workerflow-runtime-api-canary"
      canary_health_url:
        description: "Optional canary health URL (for example https://<canary>/api/health)"
        required: false
        type: string
      production_health_url:
        description: "Optional production health URL (for example https://<prod>/api/health)"
        required: false
        type: string

jobs:
  release-checks:
    name: release-checks
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: cloudflare
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: cloudflare/package-lock.json
      - run: npm ci
      - run: npm run release:check

  dashboard-release-check:
    name: dashboard-release-check
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: pages-dashboard
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: pages-dashboard/package-lock.json
      - run: npm ci
      - run: npm run release:check

  deploy-canary:
    name: deploy-canary
    runs-on: ubuntu-latest
    needs:
      - release-checks
      - dashboard-release-check
    defaults:
      run:
        working-directory: cloudflare
    env:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      CF_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CF_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: cloudflare/package-lock.json
      - run: npm ci
      - name: Check required deploy secrets
        run: |
          set -euo pipefail
          missing=0
          for key in CLOUDFLARE_API_TOKEN CLOUDFLARE_ACCOUNT_ID; do
            if [ -z "${!key:-}" ]; then
              echo "missing required secret: $key"
              missing=1
            fi
          done
          if [ "$missing" -ne 0 ]; then
            exit 1
          fi
      - name: Validate before deploy commands
        run: npm run release:check
      - name: Deploy canary API worker
        run: |
          npx wrangler deploy \
            --config workers/api/wrangler.jsonc \
            --name "${{ inputs.canary_worker_name }}"
      - name: Canary health validation
        if: ${{ inputs.canary_health_url != '' }}
        run: |
          set -euo pipefail
          curl -fsS --retry 3 --retry-delay 2 "${{ inputs.canary_health_url }}"

  full-rollout:
    name: full-rollout
    runs-on: ubuntu-latest
    if: ${{ inputs.rollout_mode == 'full-rollout' }}
    needs:
      - deploy-canary
    defaults:
      run:
        working-directory: cloudflare
    env:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      CF_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CF_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: cloudflare/package-lock.json
      - run: npm ci
      - name: Check required deploy secrets
        run: |
          set -euo pipefail
          missing=0
          for key in CLOUDFLARE_API_TOKEN CLOUDFLARE_ACCOUNT_ID; do
            if [ -z "${!key:-}" ]; then
              echo "missing required secret: $key"
              missing=1
            fi
          done
          if [ "$missing" -ne 0 ]; then
            exit 1
          fi
      - name: Validate before deploy commands
        run: npm run release:check
      - name: Deploy runtime workers
        run: |
          npm run deploy:workflow
          npm run deploy:queue
          npm run deploy:api
          npm run deploy:scheduler
          npm run deploy:ops
      - name: Production health validation
        if: ${{ inputs.production_health_url != '' }}
        run: |
          set -euo pipefail
          curl -fsS --retry 3 --retry-delay 2 "${{ inputs.production_health_url }}"
